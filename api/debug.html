<!DOCTYPE html>
<html>
<head>
    <title>Excel Debug Tool - Enhanced</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #007bff; padding: 30px; text-align: center; margin: 20px 0; border-radius: 10px; background: #f8f9fa; }
        .result { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 4px solid #007bff; }
        pre { background: #fff; padding: 15px; border: 1px solid #ddd; overflow-x: auto; border-radius: 5px; font-size: 12px; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .loading { display: none; color: #007bff; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { color: #0c5460; background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Excel File Debug Tool - Enhanced</h1>
        <p>This tool will analyze your Excel file and show exactly why the bulk upload is failing.</p>
        
        <div class="upload-area">
            <h3>üìÅ Upload Your Excel File</h3>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
            <br><br>
            <button onclick="debugFile()" id="debugBtn">üîç Debug Excel File</button>
            <button onclick="testFile()" id="testBtn">üß™ Test Excel Structure</button>
            <button onclick="testProcessing()" id="processBtn">‚öôÔ∏è Test Processing</button>
            <div class="loading" id="loading">‚è≥ Analyzing file...</div>
        </div>
        
        <div id="result" class="result" style="display: none;">
            <h3>üìä Debug Results:</h3>
            <div id="resultContent"></div>
        </div>
        
        <div class="info">
            <h4>üí° What This Tool Shows:</h4>
            <ul>
                <li><strong>Raw Headers:</strong> The actual column names in your Excel file</li>
                <li><strong>Data Structure:</strong> How the data is organized</li>
                <li><strong>Header Mapping:</strong> How headers are mapped to expected fields</li>
                <li><strong>Field Analysis:</strong> Which required fields are present/missing</li>
                <li><strong>Sample Data:</strong> First few rows of processed data</li>
            </ul>
        </div>
    </div>

    <script>
        async function debugFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const debugBtn = document.getElementById('debugBtn');
            const testBtn = document.getElementById('testBtn');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            if (!file) {
                alert('Please select a file first');
                return;
            }
            
            debugBtn.disabled = true;
            testBtn.disabled = true;
            loading.style.display = 'block';
            result.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/debug/debug-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<div class="success">‚úÖ File analyzed successfully!</div>';
                    
                    // Show sheet names
                    if (data.sheetNames) {
                        html += `<h4>üìã Sheet Names:</h4><p>${data.sheetNames.join(', ')}</p>`;
                    }
                    
                    // Show headers
                    if (data.headers) {
                        html += `<h4>üìù Raw Headers (Array Format):</h4>`;
                        html += `<table><tr>`;
                        data.headers.forEach(header => {
                            html += `<th>${header || '(empty)'}</th>`;
                        });
                        html += `</tr></table>`;
                    }
                    
                    if (data.objectHeaders) {
                        html += `<h4>üìù Headers (Object Format):</h4>`;
                        html += `<p>${data.objectHeaders.join(', ')}</p>`;
                    }
                    
                    // Show sample data
                    if (data.arrayFormat && data.arrayFormat.length > 0) {
                        html += `<h4>üìä Sample Data (First 3 Rows):</h4>`;
                        html += `<table>`;
                        data.arrayFormat.forEach((row, index) => {
                            html += `<tr>`;
                            if (index === 0) {
                                // Header row
                                row.forEach(cell => {
                                    html += `<th>${cell || '(empty)'}</th>`;
                                });
                            } else {
                                // Data rows
                                row.forEach(cell => {
                                    html += `<td>${cell || '(empty)'}</td>`;
                                });
                            }
                            html += `</tr>`;
                        });
                        html += `</table>`;
                    }
                    
                    // Show object format
                    if (data.objectFormat && data.objectFormat.length > 0) {
                        html += `<h4>üìä Sample Data (Object Format):</h4>`;
                        html += `<pre>${JSON.stringify(data.objectFormat.slice(0, 3), null, 2)}</pre>`;
                    }
                    
                    resultContent.innerHTML = html;
                } else {
                    resultContent.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                }
                
                result.style.display = 'block';
                
            } catch (error) {
                resultContent.innerHTML = `<div class="error">‚ùå Network Error: ${error.message}</div>`;
                result.style.display = 'block';
            } finally {
                debugBtn.disabled = false;
                testBtn.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        async function testFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const debugBtn = document.getElementById('debugBtn');
            const testBtn = document.getElementById('testBtn');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            if (!file) {
                alert('Please select a file first');
                return;
            }
            
            debugBtn.disabled = true;
            testBtn.disabled = true;
            loading.style.display = 'block';
            result.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/debug/test-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<div class="success">‚úÖ Excel structure test completed!</div>';
                    
                    html += `<h4>üìä File Analysis:</h4>`;
                    html += `<p><strong>File:</strong> ${data.fileName}</p>`;
                    html += `<p><strong>Total Rows:</strong> ${data.totalRows}</p>`;
                    html += `<p><strong>Sheets:</strong> ${data.sheetNames.join(', ')}</p>`;
                    
                    if (data.firstFiveRows && data.firstFiveRows.length > 0) {
                        html += `<h4>üìã First 5 Rows:</h4>`;
                        html += `<table>`;
                        data.firstFiveRows.forEach((row, index) => {
                            html += `<tr>`;
                            html += `<td><strong>Row ${index + 1}:</strong></td>`;
                            row.forEach(cell => {
                                html += `<td>${cell || '(empty)'}</td>`;
                            });
                            html += `</tr>`;
                        });
                        html += `</table>`;
                    }
                    
                    if (data.rowAnalysis && data.rowAnalysis.length > 0) {
                        html += `<h4>üîç Row Analysis (First 10 rows with data):</h4>`;
                        html += `<table>`;
                        html += `<tr><th>Row #</th><th>Has Data</th><th>Non-Empty Cells</th><th>Cells</th></tr>`;
                        data.rowAnalysis.forEach(row => {
                            html += `<tr>`;
                            html += `<td>${row.rowNumber}</td>`;
                            html += `<td>${row.hasData ? '‚úÖ' : '‚ùå'}</td>`;
                            html += `<td>${row.nonEmptyCells}</td>`;
                            html += `<td>${row.cells.join(', ') || '(all empty)'}</td>`;
                            html += `</tr>`;
                        });
                        html += `</table>`;
                    }
                    
                    resultContent.innerHTML = html;
                } else {
                    resultContent.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                }
                
                result.style.display = 'block';
                
            } catch (error) {
                resultContent.innerHTML = `<div class="error">‚ùå Network Error: ${error.message}</div>`;
                result.style.display = 'block';
            } finally {
                debugBtn.disabled = false;
                testBtn.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        async function testProcessing() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const debugBtn = document.getElementById('debugBtn');
            const testBtn = document.getElementById('testBtn');
            const processBtn = document.getElementById('processBtn');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            if (!file) {
                alert('Please select a file first');
                return;
            }
            
            debugBtn.disabled = true;
            testBtn.disabled = true;
            processBtn.disabled = true;
            loading.style.display = 'block';
            result.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/debug/test-processing', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<div class="success">‚úÖ Excel processing test completed!</div>';
                    
                    html += `<h4>üìä Processing Results:</h4>`;
                    html += `<p><strong>File:</strong> ${data.fileName}</p>`;
                    html += `<p><strong>Total Rows:</strong> ${data.totalRows}</p>`;
                    
                    if (data.headers && data.headers.length > 0) {
                        html += `<h4>üìù Headers:</h4>`;
                        html += `<p>${data.headers.join(', ')}</p>`;
                    }
                    
                    if (data.sampleData && data.sampleData.length > 0) {
                        html += `<h4>üìã Sample Data (First 4 Rows):</h4>`;
                        html += `<table>`;
                        data.sampleData.forEach((row, index) => {
                            html += `<tr>`;
                            html += `<td><strong>Row ${index + 1}:</strong></td>`;
                            row.forEach(cell => {
                                html += `<td>${cell || '(empty)'}</td>`;
                            });
                            html += `</tr>`;
                        });
                        html += `</table>`;
                    }
                    
                    if (data.processedResults && data.processedResults.length > 0) {
                        html += `<h4>‚öôÔ∏è Processed Results:</h4>`;
                        html += `<pre>${JSON.stringify(data.processedResults, null, 2)}</pre>`;
                    }
                    
                    resultContent.innerHTML = html;
                } else {
                    resultContent.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                }
                
                result.style.display = 'block';
                
            } catch (error) {
                resultContent.innerHTML = `<div class="error">‚ùå Network Error: ${error.message}</div>`;
                result.style.display = 'block';
            } finally {
                debugBtn.disabled = false;
                testBtn.disabled = false;
                processBtn.disabled = false;
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>